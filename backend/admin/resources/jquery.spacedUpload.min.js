!function(e){var t=!1;window.XMLHttpRequest&&(t=null!=(new XMLHttpRequest).upload);function a(e){return"[object File]"===Object.prototype.toString.call(e)}function n(e){return e instanceof File||e instanceof Blob||a(e)}e.extend(e.support,{fileSelecting:null!=window.File&&null!=window.FileList,fileReading:null!=window.FileReader,fileSending:null!=window.FormData,uploadControl:t}),e.fn.spacedUpload=function(t,l){if(0==this.length)return this;var o=this,i=o._spacedUploadQueue,d=o._spacedUploadSettings||{};if(!t||e.isPlainObject(t)){if(o._spacedUploadSettings=e.extend({url:"/admin/files/upload/",multiple:!1,autoupload:!0,fieldName:"file",dropping:!0,dropBox:!1,limit:!1,extentions:[],onSelect:!1,onSelectAll:!1,onLimitExceeded:!1,onAllComplete:!1,onError:!1},t||{}),o._spacedUploadQueue={},o._spacedUploadItemsCount=0,i=o._spacedUploadQueue,d=o._spacedUploadSettings,o._spacedUploadFilesAddMap=function(t,n,l){var i=e.isFunction(n);if(!e.support.fileSelecting){if(o._spacedUploadItemsCount===d.limit)return!!e.isFunction(d.onLimitExceeded)&&d.onLimitExceeded.call(o);var p={fake:!0,name:t.value,inputElement:t};return!(!i||n.call(o,p))||(o.spacedUpload("addItem",p),e.isFunction(l)&&l.call(o),d.autoupload&&o.spacedUpload("startUpload"),!0)}return(t instanceof FileList||a(t[0]))&&(e.each(t,function(t,a){if(o._spacedUploadSettings.extentions.length){const e=a.name.split("."),t=e[e.length-1].toLowerCase();if(!o._spacedUploadSettings.extentions.includes(t))return"function"==typeof o._spacedUploadSettings.onError&&o._spacedUploadSettings.onError("bad_type",a),!0}return o._spacedUploadItemsCount===d.limit?!!e.isFunction(d.onLimitExceeded)&&d.onLimitExceeded.call(o):!(!i||n.call(o,a))||void o.spacedUpload("addItem",{file:a})}),e.isFunction(l)&&l.call(o),d.autoupload&&o.spacedUpload("startUpload")),!0},o._spacedUploadUploadItem=function(t,a){if(!n(a.file))return!1;var l=new XMLHttpRequest,o=0;l.upload&&(l.upload.onprogress=function(t){t.lengthComputable&&(o=100*t.loaded/t.total,e.isFunction(a.onProgress)&&a.onProgress.call(a,Math.round(o)))}),l.onload=l.onerror=function(t){var n=e.isFunction(a.onComplete);4==this.readyState&&(a.cancelled=a.cancelled||!1,200==this.status?(o<100&&e.isFunction(a.onProgress)&&a.onProgress.call(a,100),n&&a.onComplete.call(a,!0,this.responseText)):n&&a.onComplete.call(a,!1,this.responseText,this.status))};var i=a.replaceName||a.file.name;if(l.open("POST",t,!0),e.support.fileSending){var p=new FormData;p.append(a.fieldName||"file",a.file),d.data&&p.append("data",JSON.stringify(d.data)),l.send(p)}else if(e.support.fileReading&&l.sendAsBinary){l.setRequestHeader("Content-Type","multipart/form-data, boundary=xxxxxxxxx"),l.setRequestHeader("Cache-Control","no-cache");var r="--xxxxxxxxx\r\n";i=unescape(encodeURIComponent(i)),r+="Content-Disposition: form-data; name='"+(a.fieldName||"file")+"'; filename='"+i+"'\r\n",r+="Content-Type: application/octet-stream\r\n\r\n",r+=(a.file.getAsBinary?a.file.getAsBinary():a.file.readAsBinary())+"\r\n",r+="--xxxxxxxxx--",l.sendAsBinary(r)}else l.setRequestHeader("Upload-Filename",a.file.name),l.setRequestHeader("Upload-Size",a.file.size),l.setRequestHeader("Upload-Type",a.file.type),l.send(a.file);a.xhr=l},"INPUT"==o.get(0).tagName&&"file"==this.attr("type")){var p=o.eq(0).attr("name");if(e.support.fileSelecting)d.multiple&&o.attr("multiple",!0);else{"]"!=p.charAt(p.length-1)&&(p+="[]"),o.attr("name",p),o.attr("multiple",!1);var r=o.parents("form").attr("action");o._spacedUploadFakeForm=e("<form/>").attr({method:"post",enctype:"multipart/form-data",action:r}).hide().appendTo("body")}o._spacedUploadChangeCallback=function(){o._spacedUploadFilesAddMap(e.support.fileSelecting?this.files:this,d.onSelect,d.onSelectAll)},o.on({change:o._spacedUploadChangeCallback})}return d.dropping&&(o.on({drop:function(e){return o._spacedUploadFilesAddMap(e.originalEvent.dataTransfer.files,d.onSelect,d.onSelectAll),!1}}),d.dropBox&&e(d.dropBox).on({drop:function(e){return o._spacedUploadFilesAddMap(e.originalEvent.dataTransfer.files,d.onSelect,d.onSelectAll),!1}})),o}switch(t){case"addItem":if(!l)return!1;var s=function e(t,a){return a=a||"",0==(t=parseInt(t))||isNaN(t)?a:a+String.fromCharCode(Math.floor(26*Math.random())+97)+e(--t)}(5);if(l.file.fake){var c=e(l.file.inputElement),u=e(c).clone();return e(c).before(u),e(c).attr("id",s),e(c).appendTo(o._spacedUploadFakeForm),u.on({change:o._spacedUploadChangeCallback}),o._spacedUploadItemsCount++,s}return!!n(l.file)&&(i[s]=l,o._spacedUploadItemsCount++,s);case"startUpload":if(!d.url)return o;if(!e.support.fileSelecting)return o._spacedUploadFakeForm.submit(),o;e.each(i,function(t,a){var n=a.onComplete;a.fieldName=a.fieldName||d.fieldName,a.onComplete=function(a,l,p){this.cancelled||(delete i[t],o._spacedUploadItemsCount--),e.isFunction(n)&&n.call(this,a,l,p),0==o._spacedUploadItemsCount&&e.isFunction(d.onAllComplete)&&d.onAllComplete.call(o)},o._spacedUploadUploadItem(d.url,a)});break;case"itemsCount":return o._spacedUploadItemsCount;case"cancelAll":if(!e.support.fileSelecting)return o._spacedUploadItemsCount=0,o._spacedUploadFakeForm.empty(),o;e.each(i,function(e,t){o.spacedUpload("cancel",e)});break;case"cancel":s=l.toString();if(o._spacedUploadItemsCount>0){if(!e.support.fileSelecting){var f=e("#"+s);return f.length>0&&(f.remove(),o._spacedUploadItemsCount--),o}void 0!==i[s]&&(i[s].xhr&&(i[s].cancelled=!0,i[s].xhr.abort()),delete i[s],o._spacedUploadItemsCount--)}break;case"setParam":var m=["url","multiple","fieldName","limit","data"];e.each(l,function(t,a){e.inArray(t,m)&&(o._spacedUploadSettings[t]=a)})}return o}}(window.jQuery);
